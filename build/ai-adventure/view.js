(()=>{"use strict";var e={338:(e,t,r)=>{var n=r(795);t.H=n.createRoot,n.hydrateRoot},795:e=>{e.exports=window.ReactDOM}},t={};function r(n){var a=t[n];if(void 0!==a)return a.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,r),o.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const n=window.React;var a=r(338);const o=window.wp.element,s=window.wp.apiFetch;var i=r.n(s);const c=({title:e,description:t,buttonText:r,onButtonClick:a,children:o})=>(0,n.createElement)("div",{className:"ai-adventure-opening-screen"},e&&(0,n.createElement)("h2",{className:"ai-adventure-opening-title"},e),t&&(0,n.createElement)("p",{className:"ai-adventure-opening-description"},t),o,r&&(0,n.createElement)("button",{className:"ai-adventure-opening-button",onClick:a},r)),l=({attributes:e,innerBlocks:t})=>{const[r,a]=(0,o.useState)([]),[s,l]=(0,o.useState)(!1),[u,p]=(0,o.useState)(null),[d,m]=(0,o.useState)(""),[g,v]=(0,o.useState)(!1),[y,h]=(0,o.useState)(!1),[b,f]=(0,o.useState)(null),[P,S]=(0,o.useState)([]),[E,k]=(0,o.useState)([]),A=(0,o.useRef)(null);(0,o.useEffect)(()=>{A.current&&(A.current.scrollTop=A.current.scrollHeight)},[r]);const w=e=>{for(const r of t){const t=r.innerBlocks.find(t=>t.attributes.stepId===e);if(t)return{step:t,path:r}}return{step:null,path:null}};return g?y?(0,n.createElement)(c,{title:"Game Over",description:"Thank you for playing!",buttonText:"Restart",onButtonClick:()=>{h(!1),v(!1),a([]),f(null),S([]),k([])}}):((0,o.useEffect)(()=>{if(!b)return;if(0===r.length)return;const{step:t,path:n}=w(b);t&&n?(async()=>{l(!0);try{const o=await i()({path:"/chubes-games/v1/adventure",method:"POST",data:{is_initial_turn:!0,gameMasterPersona:e.gameMasterPersona,adventurePrompt:e.adventurePrompt,pathPrompt:n.attributes.pathPrompt,stepPrompt:t.attributes.stepPrompt,conversationHistory:r.slice(-10),previousSteps:[...P,b],storyProgression:E}});a(e=>[...e,{type:"ai",content:o.narrative}])}catch(e){p(`Error transitioning to new step: ${e.message}`),console.error(e)}finally{l(!1)}})():(p(`Error: Could not find step with ID: ${b}`),l(!1))},[b]),(0,o.useEffect)(()=>{if(!g)return;Array.isArray(t)&&t.reduce((e,t)=>Array.isArray(t.innerBlocks)?e.concat(t.innerBlocks):e,[]);const r=Array.isArray(t)&&t.length>0&&Array.isArray(t[0].innerBlocks)&&t[0].innerBlocks.length>0?t[0].innerBlocks[0]:null;if(r){const{step:t,path:n}=w(r.attributes.stepId);t&&n?(f(t.attributes.stepId),S([]),k([]),(async(t,r)=>{l(!0),p(null);try{const n=await i()({path:"/chubes-games/v1/adventure",method:"POST",data:{is_initial_turn:!0,gameMasterPersona:e.gameMasterPersona,adventurePrompt:e.adventurePrompt,pathPrompt:r.attributes.pathPrompt,stepPrompt:t.attributes.stepPrompt,conversationHistory:[],previousSteps:[],storyProgression:[]}});a([{type:"ai",content:n.narrative}])}catch(e){p(e.message||"Error fetching initial narrative."),console.error(e)}finally{l(!1)}})(t,n)):(p("Game consistency error. Could not find path for the first step."),l(!1))}else p("Game configuration error: No paths or steps found."),l(!1)},[g,t,e]),(0,n.createElement)("div",{className:"ai-adventure-game"},(0,n.createElement)("div",{className:"story-log",ref:A},r.map((e,t)=>(0,n.createElement)("div",{key:t,className:`story-entry ${e.type}`},e.content)),s&&(0,n.createElement)("div",{className:"story-entry ai"},"..."),u&&(0,n.createElement)("div",{className:"story-entry error"},u)),(0,n.createElement)("form",{className:"player-input-form",onSubmit:async t=>{if(t.preventDefault(),!d.trim()||s)return;const n=d;m(""),a(e=>[...e,{type:"player",content:n}]),l(!0),p(null);try{const{step:t,path:o}=w(b);if(!t)throw new Error("Current game step could not be found.");const s=(t.attributes.triggers||[]).map((e,t)=>({id:e.destinationStep||`trigger-${t}`,action:e.triggerPhrase,destination:e.destinationStep})),c=r.slice(-10),l=[...P,b],u=[...E],p=await i()({path:"/chubes-games/v1/adventure",method:"POST",data:{playerInput:n,triggers:s,gameMasterPersona:e.gameMasterPersona,adventurePrompt:e.adventurePrompt,pathPrompt:o.attributes.pathPrompt,stepPrompt:t.attributes.stepPrompt,conversationHistory:c,previousSteps:l,storyProgression:u}});if(a(e=>[...e,{type:"ai",content:p.narrative}]),p.nextStepId){if("end_game"===p.nextStepId)return void h(!0);let e=s.find(e=>e.destination===p.nextStepId),r=e?e.action:n;S(l),f(p.nextStepId),k(e=>[...e,{stepAction:t.attributes.stepPrompt,triggerActivated:r}])}}catch(e){p(e.message||"An error occurred processing your action."),console.error(e)}finally{l(!1)}}},(0,n.createElement)("input",{type:"text",value:d,onChange:e=>m(e.target.value),placeholder:"What do you do?",disabled:s}),(0,n.createElement)("button",{type:"submit",disabled:s},"Send")))):(0,n.createElement)(c,{title:e.title||"AI Adventure",description:e.adventurePrompt||"No adventure description provided.",buttonText:"Play",onButtonClick:()=>v(!0)})},u=({attributes:e,innerBlocks:t})=>(console.log("AI Adventure App - Received data:",{attributes:e,innerBlocks:t}),console.log("InnerBlocks length:",t?t.length:"undefined"),console.log("InnerBlocks structure:",t),e&&t&&0!==t.length?(0,n.createElement)(o.StrictMode,null,(0,n.createElement)(l,{attributes:e,innerBlocks:t})):(0,n.createElement)("p",null,"Loading Adventure..."));document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelectorAll(".wp-block-chubes-games-ai-adventure");console.log("Found AI Adventure blocks:",e.length),e.forEach((e,t)=>{console.log(`Processing block ${t}:`,e);const r={gameMasterPersona:"You are a helpful and creative text-based adventure game master.",title:e.querySelector(".adventure-title")?.textContent||"",adventurePrompt:e.querySelector(".adventure-prompt-storage p")?.textContent||""},o=e.querySelectorAll(".wp-block-chubes-games-ai-adventure-path"),s=Array.from(o).map((e,t)=>{const r=e.querySelector(".ai-adventure-path-prompt")?.textContent||"",n=e.querySelector("h3")?.textContent||"",a=e.querySelectorAll(".wp-block-chubes-games-ai-adventure-step");return{name:"chubes-games/ai-adventure-path",attributes:{pathPrompt:r,label:n},innerBlocks:Array.from(a).map((e,r)=>{const n=e.querySelector(".ai-adventure-step-prompt")?.textContent||"",a=e.querySelector("h4")?.textContent||"",o=e.dataset.stepId||`step-${t}-${r}`;let s=[];try{const t=e.dataset.triggers;t&&(s=JSON.parse(t))}catch(e){console.warn("Failed to parse triggers for step:",o,e),s=[]}return{name:"chubes-games/ai-adventure-step",attributes:{stepPrompt:n,label:a,stepId:o,triggers:s}}})}});console.log(`Block ${t} - Extracted data:`,{attributes:r,innerBlocks:s}),(0,a.H)(e).render((0,n.createElement)(u,{attributes:r,innerBlocks:s}))})})})();