(()=>{"use strict";var e={338:(e,t,r)=>{var a=r(795);t.H=a.createRoot,a.hydrateRoot},795:e=>{e.exports=window.ReactDOM}},t={};function r(a){var n=t[a];if(void 0!==n)return n.exports;var o=t[a]={exports:{}};return e[a](o,o.exports,r),o.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var a in t)r.o(t,a)&&!r.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const a=window.React;var n=r(338);const o=window.wp.element,s=window.wp.apiFetch;var i=r.n(s);const c=({title:e,description:t,buttonText:r,onButtonClick:n,children:o})=>(0,a.createElement)("div",{className:"ai-adventure-opening-screen"},e&&(0,a.createElement)("h2",{className:"ai-adventure-opening-title"},e),t&&(0,a.createElement)("p",{className:"ai-adventure-opening-description"},t),o,r&&(0,a.createElement)("button",{className:"ai-adventure-opening-button",onClick:n},r)),l=({attributes:e,innerBlocks:t})=>{const[r,n]=(0,o.useState)([]),[s,l]=(0,o.useState)(!1),[p,d]=(0,o.useState)(null),[m,g]=(0,o.useState)(""),[v,E]=(0,o.useState)("AWAITING_NAME"),[h,y]=(0,o.useState)(""),[f,b]=(0,o.useState)(""),[N,S]=(0,o.useState)(null),[A,P]=(0,o.useState)([]),[I,w]=(0,o.useState)([]),k=(0,o.useRef)(null);(0,o.useEffect)(()=>{k.current&&(k.current.scrollTop=k.current.scrollHeight)},[r]);const x=e=>{for(const r of t){const t=r.innerBlocks.find(t=>t.attributes.stepId===e);if(t)return{step:t,path:r}}return{step:null,path:null}};(0,o.useEffect)(()=>{if("PLAYING"!==v)return;if(N)return void(async t=>{l(!0),d(null);try{const{step:a,path:o}=x(t);if(!a||!o)throw new Error("Could not find the new step's data.");const s=(a.attributes.triggers||[]).map((e,t)=>({id:e.destinationStep||`trigger-${t}`,action:e.triggerPhrase,destination:e.destinationStep})),c=r.slice(-2),l=await i()({path:"/chubes-games/v1/adventure",method:"POST",data:{isIntroduction:!0,characterName:h,triggers:s,transitionContext:c,gameMasterPersona:e.gameMasterPersona,adventureTitle:e.title,adventurePrompt:e.adventurePrompt,pathPrompt:o.attributes.pathPrompt,stepPrompt:a.attributes.stepPrompt}});n(e=>[...e,{type:"ai",content:l.narrative}])}catch(e){d(e.message||"Error fetching the step's introduction."),console.error(e)}finally{l(!1)}})(N);const a=Array.isArray(t)&&t.length>0&&Array.isArray(t[0].innerBlocks)&&t[0].innerBlocks.length>0?t[0].innerBlocks[0]:null;if(a){const e=a.attributes.stepId||a.clientId;S(e)}else d("Game configuration error: No paths or steps found."),l(!1)},[v,N]);let M;return M="AWAITING_NAME"===v?(0,a.createElement)(c,{title:e.title||"AI Adventure",description:e.adventurePrompt||"No adventure description provided."},(0,a.createElement)("form",{onSubmit:e=>{e.preventDefault(),f.trim()&&(y(f.trim()),E("PLAYING"))},className:"character-name-form"},(0,a.createElement)("input",{type:"text",value:f,onChange:e=>b(e.target.value),placeholder:"Enter your character name",autoFocus:!0}),(0,a.createElement)("button",{type:"submit"},"Begin Adventure"))):(0,a.createElement)(a.Fragment,null,(0,a.createElement)("div",{className:"story-log",ref:k},r.map((e,t)=>"ai"!==e.type||e.content?.trim()?(0,a.createElement)("div",{key:t,className:`story-entry ${e.type}`},"ai"===e.type?u(e.content):e.content):null),s&&(0,a.createElement)("div",{className:"story-entry ai loading-dots"},(0,a.createElement)("span",null,"."),(0,a.createElement)("span",null,"."),(0,a.createElement)("span",null,".")),p&&(0,a.createElement)("div",{className:"story-entry error"},"Error: ",p)),"GAME_OVER"!==v?(0,a.createElement)("form",{onSubmit:async t=>{if(t.preventDefault(),!m.trim()||s)return;const a=m;g(""),n(e=>[...e,{type:"player",content:a}]),l(!0),d(null);try{const{step:t,path:o}=x(N);if(!t)throw new Error("Current game step could not be found.");const s=(t.attributes.triggers||[]).map((e,t)=>({id:e.destinationStep||`trigger-${t}`,action:e.triggerPhrase,destination:e.destinationStep})),c=r.slice(-10),l=[...A,N],u=[...I],p=await i()({path:"/chubes-games/v1/adventure",method:"POST",data:{playerInput:a,characterName:h,triggers:s,gameMasterPersona:e.gameMasterPersona,adventureTitle:e.title,adventurePrompt:e.adventurePrompt,pathPrompt:o.attributes.pathPrompt,stepPrompt:t.attributes.stepPrompt,conversationHistory:c,previousSteps:l,storyProgression:u}});if(n(e=>[...e,{type:"ai",content:p.narrative}]),p.nextStepId){if("end_game"===p.nextStepId)return void E("GAME_OVER");let e=s.find(e=>e.destination===p.nextStepId),r=e?e.action:a;P(l),w(e=>[...e,{stepAction:t.attributes.stepPrompt,triggerActivated:r}]),S(p.nextStepId)}}catch(e){d(e.message||"An error occurred processing your action."),console.error(e)}finally{l(!1)}},className:"player-input-form"},(0,a.createElement)("input",{type:"text",value:m,onChange:e=>g(e.target.value),placeholder:"What do you do next?",disabled:s,autoFocus:!0}),(0,a.createElement)("button",{type:"submit",disabled:s},"Send")):(0,a.createElement)("div",{className:"game-over-controls"},(0,a.createElement)("div",{className:"story-entry ai"},"Game Over. Thanks for playing, ",h,"!"),(0,a.createElement)("button",{onClick:()=>{E("AWAITING_NAME"),n([]),S(null),P([]),w([]),y(""),b("")},className:"restart-button"},"Play Again"))),(0,a.createElement)("div",{className:"ai-adventure-game"},M)};document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".wp-block-chubes-games-ai-adventure").forEach(e=>{try{const t=JSON.parse(e.dataset.attributes||"{}"),r=JSON.parse(e.dataset.innerblocks||"[]");(0,n.H)(e).render((0,a.createElement)(o.StrictMode,null,(0,a.createElement)(l,{attributes:t,innerBlocks:r})))}catch(t){console.error("Failed to initialize AI Adventure Game:",t),e.innerHTML="<p>Error: Could not load game data. Please check the browser console.</p>"}})});const u=e=>{const t=e.split(/(\[SCENE\]|\[DIALOGUE\])/);let r="dialogue";const n=[];return t.forEach((e,t)=>{"[SCENE]"===e?r="scene":"[DIALOGUE]"===e?r="dialogue":e.trim()&&n.push((0,a.createElement)("span",{key:t,className:`ai-${r}`},e.trim()))}),0===n.length?(0,a.createElement)("span",{className:"ai-dialogue"},e):n}})();