(()=>{"use strict";var e={338:(e,t,r)=>{var a=r(795);t.H=a.createRoot,a.hydrateRoot},795:e=>{e.exports=window.ReactDOM}},t={};function r(a){var n=t[a];if(void 0!==n)return n.exports;var s=t[a]={exports:{}};return e[a](s,s.exports,r),s.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var a in t)r.o(t,a)&&!r.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const a=window.React;var n=r(338);const s=window.wp.element,o=window.wp.apiFetch;var i=r.n(o);const c=({attributes:e,innerBlocks:t})=>{const[r,n]=(0,s.useState)([]),[o,c]=(0,s.useState)(!0),[u,l]=(0,s.useState)(null),[p,d]=(0,s.useState)(""),m=(0,s.useRef)(null),[f,h]=(0,s.useState)(null);(0,s.useEffect)(()=>{m.current&&(m.current.scrollTop=m.current.scrollHeight)},[r]);const v=e=>{for(const r of t){const t=r.innerBlocks.find(t=>t.attributes.stepId===e);if(t)return{step:t,path:r}}return{step:null,path:null}};return(0,s.useEffect)(()=>{if(!f)return;if(0===r.length)return;const{step:e}=v(f);e?(n(t=>[...t,{type:"ai",content:e.attributes.stepPrompt}]),c(!1)):(l(`Error: Could not find step with ID: ${f}`),c(!1))},[f]),(0,s.useEffect)(()=>{const r=t.flatMap(e=>e.innerBlocks).find(e=>e.attributes.isFirstStep);if(r){const{step:t,path:a}=v(r.attributes.stepId);t&&a?(h(t.attributes.stepId),(async(t,r)=>{c(!0),l(null);try{const a=await i()({path:"/chubes-games/v1/adventure",method:"POST",data:{is_initial_turn:!0,gameMasterPersona:e.gameMasterPersona,adventurePrompt:e.adventurePrompt,pathPrompt:r.attributes.pathPrompt,stepPrompt:t.attributes.stepPrompt}});n([{type:"ai",content:a.narrative}])}catch(e){l(e.message||"Error fetching initial narrative."),console.error(e)}finally{c(!1)}})(t,a)):(l("Game consistency error. Could not find path for the first step."),c(!1))}else l("Game configuration error: No starting step found."),c(!1)},[t,e]),(0,a.createElement)("div",{className:"chubes-game-window"},(0,a.createElement)("div",{className:"ai-adventure-game"},(0,a.createElement)("div",{className:"story-log",ref:m},r.map((e,t)=>(0,a.createElement)("div",{key:t,className:`story-entry ${e.type}`},e.content)),o&&(0,a.createElement)("div",{className:"story-entry ai"},"..."),u&&(0,a.createElement)("div",{className:"story-entry error"},u)),(0,a.createElement)("form",{className:"player-input-form",onSubmit:async t=>{if(t.preventDefault(),!p.trim()||o)return;const r=p;d(""),n(e=>[...e,{type:"player",content:r}]),c(!0),l(null);try{const{step:t,path:a}=v(f);if(!t)throw new Error("Current game step could not be found.");const n=t.attributes.triggers.map(e=>({id:e.destinationStep,action:e.triggerPhrase,destination:e.destinationStep})),s=(await i()({path:"/chubes-games/v1/adventure",method:"POST",data:{playerInput:r,triggers:n,gameMasterPersona:e.gameMasterPersona,adventurePrompt:e.adventurePrompt,pathPrompt:a.attributes.pathPrompt,stepPrompt:t.attributes.stepPrompt}})).nextStepId;if(!s)throw new Error("AI did not return a valid next step.");h(s)}catch(e){l(e.message||"An error occurred processing your action."),console.error(e),c(!1)}}},(0,a.createElement)("input",{type:"text",value:p,onChange:e=>d(e.target.value),placeholder:"What do you do?",disabled:o}),(0,a.createElement)("button",{type:"submit",disabled:o},"Send"))))},u=({attributes:e,innerBlocks:t})=>e&&t&&0!==t.length?(0,a.createElement)(s.StrictMode,null,(0,a.createElement)(c,{attributes:e,innerBlocks:t})):(0,a.createElement)("p",null,"Loading Adventure...");document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".wp-block-chubes-games-ai-adventure").forEach(e=>{const t=JSON.parse(e.dataset.attributes||"{}"),r=JSON.parse(e.dataset.innerblocks||"[]");(0,n.H)(e).render((0,a.createElement)(u,{attributes:t,innerBlocks:r}))})})})();